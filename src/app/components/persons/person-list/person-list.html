<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">
    <i class="bi bi-people me-2"></i>Persons
  </h2>
  <button class="btn btn-primary" (click)="toggleCreateForm()">
    <i class="bi bi-{{ showCreateForm() ? 'x' : 'plus' }} me-1"></i>
    {{ showCreateForm() ? 'Cancel' : 'Add Person' }}
  </button>
</div>

@if (showCreateForm()) {
  <div class="card mb-4">
    <div class="card-body">
      <form [formGroup]="createForm" (ngSubmit)="createPerson()" class="row g-3">
        <div class="col-md-6">
          <input type="text" class="form-control" formControlName="name" placeholder="Full name" required>
        </div>
        <div class="col-md-6">
          <input type="email" class="form-control" formControlName="email" placeholder="email@example.com" required>
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-success me-2" [disabled]="createForm.invalid || loading()">
            <i class="bi bi-{{ loading() ? 'arrow-clockwise spin' : 'check' }} me-1"></i>Add
          </button>
          <button type="button" class="btn btn-outline-secondary" (click)="toggleCreateForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
}

@if (persons$ | async; as persons) {
  @if (persons.length > 0) {
    <div class="row g-3">
      @for (person of persons; track person.id) {
        <div class="col-md-6 col-xl-4">
          <div class="card h-100">
            <div class="card-body">
              @if (editingPerson()?.id === person.id) {
                <form [formGroup]="editForm" (ngSubmit)="updatePerson()">
                  <input type="text" class="form-control mb-3" formControlName="name" required>
                  <input type="email" class="form-control mb-3" formControlName="email" required>
                  <div class="btn-group w-100">
                    <button type="submit" class="btn btn-success" [disabled]="editForm.invalid || loading()">
                      <i class="bi bi-{{ loading() ? 'arrow-clockwise spin' : 'check' }}"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" (click)="cancelEdit()">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </form>
              } @else {
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <h6 class="card-title">{{ person.name }}</h6>
                    <p class="card-text text-muted small">{{ person.email }}</p>
                  </div>
                  <div ngbDropdown>
                    <button class="btn btn-sm btn-ghost" ngbDropdownToggle>
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div ngbDropdownMenu>
                      <button class="dropdown-item" (click)="startEdit(person)">
                        <i class="bi bi-pencil me-2"></i>Edit
                      </button>
                      <button class="dropdown-item text-danger" (click)="deletePerson(person)">
                        <i class="bi bi-trash me-2"></i>Delete
                      </button>
                    </div>
                  </div>
                </div>
                <small class="text-muted">{{ person.createdAt | date:'short' }}</small>
              }
            </div>
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="text-center py-5">
      <i class="bi bi-people display-1 text-muted"></i>
      <h4 class="mt-3">No Persons</h4>
      <p class="text-muted">Add your first person to get started.</p>
    </div>
  }
} @else {
  <div class="text-center py-4">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2 text-muted">Loading...</p>
  </div>
}
